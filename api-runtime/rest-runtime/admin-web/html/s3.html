<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>S3 Manager</title>
<style>
    body { font-family: Arial, sans-serif; font-size: 12px; }
    .fixed-header { position: fixed; top: 0; width: 97%; background: #fff; z-index: 1000; display: flex; justify-content: space-between; padding: 10px 20px; align-items: center; box-shadow: 0 4px 6px -6px #222; }
    .header-container { display: flex; align-items: flex-end; }
    .header-container img { margin-right: 10px; height: 28px; }
    .header-container h1 { font-size: 16px; margin: 0; }
    .searchContainer { position: relative; display: flex; align-items: center; padding-left: 0.5cm; }
    #searchInput { width: 190px; font-family: Arial, sans-serif; padding-right: 2.5cm; }
    #clearSearch { position: absolute; right: 0.1cm; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; }
    .fixed-action-buttons { display: flex; align-items: center; }
    .fixed-action-buttons button { margin-left: 10px; }
    .header-with-progress { display: flex; align-items: center; margin-bottom: 0px; }
    .progress-bar-container { width: 600px; margin-left: 10px; margin-bottom: 10px; height: 22px; background: #f0f5ff; border-radius: 4px; overflow: hidden; display: none; position: relative; z-index: 2000; }
    .progress-bar { width: 0; height: 100%; background: #cce6ff; border-radius: 4px; transition: width 2s ease; }
    #timeDisplay { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 14px; color: #333; z-index: 30; }
    .add-button { font-size: 14px; font-weight: bold; margin-left: 1px; margin-right: 5px; margin-bottom: 10px; }
    .content { margin-top: 70px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 0; }
    th, td { border: 1px solid #aaa; padding: 6px; position: relative; }
    th { background: #f2f2f2; font-size: 14px; text-align: center; }
    td { text-align: left; }
    .column-num { width: 5%; text-align: center; }
    .bucket-name-cell, .object-key-cell { font-weight: bold; }
    .bucket-name-cell.selected { color: blue; }
    .center-align { text-align: center; }
    .highlight { background: #fffab6; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .overlay-content { background: #fff; padding: 20px; border-radius: 5px; text-align: left; font-size: 12px; min-width: 300px; }
    .close-btn { position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; }
    .object-detail-table th, .object-detail-table td { border: 1px solid #ddd; }
    .object-detail-table th { width: 110px; }
    .progress-bar { transition: width 1.5s ease; }
    #object-panel { margin-top: 20px; margin-left: 40px; }
    .object-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0px; }
    .object-panel-header h2 { margin: 0; }
    .object-panel-actions { display: flex; align-items: center; }
</style>
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <img src="/spider/adminweb/images/left-menu/s3.png" alt="S3 Icon">
            <h1>S3 Manager</h1>
            <div class="searchContainer">
                <input type="text" id="searchInput" onkeyup="searchKeyword()" placeholder="Search Bucket or Object...">
                <button id="clearSearch" onclick="clearSearchInput()">X</button>
            </div>
        </div>
        <div class="fixed-action-buttons">
            <input type="checkbox" onclick="toggleSelectAll(this, 'bucket')">
            <button onclick="deleteSelectedBuckets()">Delete</button>
        </div>
    </div>

    <div class="content">
        <div class="header-with-progress">
            <button onclick="showBucketCreateOverlay()" class="add-button">+ Bucket</button>
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar"></div>
                <span id="timeDisplay"></span>
            </div>
        </div>

        <table id="bucket-table">
            <thead>
                <tr>
                    <th class="column-num">#</th>
                    <th class="center-align bucket-name-cell">Bucket Name</th>
                    <th class="center-align">Created</th>
                    <th class="center-align">Region</th>
                    <th class="center-align">Actions</th>
                    <th class="center-align"><input type="checkbox" onclick="toggleSelectAll(this, 'bucket')"></th>
                </tr>
            </thead>
            <tbody id="bucket-list-body">
                {{range $i, $b := .Buckets}}
                <tr>
                    <td class="column-num">{{$i | inc}}</td>
                    <td class="bucket-name-cell" id="bucket-{{$b.Name}}"><span style="cursor:pointer;" onclick="showObjectPanel('{{$b.Name}}')">{{$b.Name}}</span></td>
                    <td class="center-align">{{$b.CreationDate}}</td>
                    <td class="center-align">{{$b.BucketRegion}}</td>
                    <td class="center-align">
                        <button onclick="deleteBucket('{{$b.Name}}')">Delete</button>
                        <button onclick="showBucketSettings('{{$b.Name}}')">Settings</button>
                    </td>
                    <td class="center-align"><input type="checkbox" name="bucket-checkbox" value="{{$b.Name}}"></td>
                </tr>
                {{end}}
            </tbody>
        </table>

        <div id="object-panel" style="display:none;">
            <div class="header-with-progress">
                <button onclick="showObjectUploadOverlay()" class="add-button">+ Object</button>
                <div style="flex: 1;"></div>
                <div class="object-panel-actions">
                    <input type="checkbox" onclick="toggleSelectAll(this, 'object')">
                    <button onclick="deleteSelectedObjects()" style="margin-left: 10px;">Delete</button>
                    <button onclick="showObjectVersions()" style="margin-left: 10px;">Versions</button>
                </div>
            </div>
            <table id="object-table">
                <thead>
                    <tr>
                        <th class="column-num">#</th>
                        <th class="object-key-cell">Object Key</th>
                        <th class="center-align">Size</th>
                        <th class="center-align">Last Modified</th>
                        <th class="center-align">Actions</th>
                        <th class="center-align"><input type="checkbox" onclick="toggleSelectAll(this, 'object')"></th>
                    </tr>
                </thead>
                <tbody id="object-list-body">
                </tbody>
            </table>
        </div>
    </div>

    <div id="bucket-create-overlay" class="overlay">
        <div class="overlay-content" style="position:relative;">
            <button class="close-btn" onclick="hideBucketCreateOverlay()">x</button>
            <h2>Create New Bucket</h2>
            <form id="bucket-create-form" onsubmit="event.preventDefault(); createBucket();">
                <div>
                    <label>Bucket Name:</label>
                    <input type="text" id="new-bucket-name" required>
                </div>
                <div style="margin-top:20px; text-align:center;">
                    <button type="submit">Create</button>
                    <button type="button" onclick="hideBucketCreateOverlay()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="object-upload-overlay" class="overlay">
        <div class="overlay-content" style="position:relative; width: 400px;">
            <button class="close-btn" onclick="hideObjectUploadOverlay()">x</button>
            <h2>Upload Objects to <span id="upload-bucket-name"></span></h2>
            <form id="object-upload-form" onsubmit="event.preventDefault(); uploadFiles();">
                <div style="margin-bottom: 15px;">
                    <label>Select Files:</label>
                    <input type="file" id="file-input" multiple required style="margin-top: 5px;">
                </div>
                <div id="selected-files-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;">No files selected</div>
                <div id="upload-progress" style="display: none; margin-bottom: 15px;">
                    <div style="margin-bottom: 5px;">Uploading: <span id="current-file"></span></div>
                    <div style="background: #f0f0f0; height: 20px; border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar-inner" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 11px;">Progress: <span id="progress-text">0%</span></div>
                </div>
                <div style="text-align:center;">
                    <button type="submit" id="upload-btn">Upload</button>
                    <button type="button" onclick="hideObjectUploadOverlay()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="object-detail-overlay" class="overlay">
        <div class="overlay-content" style="position:relative; width: 500px;">
            <button class="close-btn" onclick="hideObjectDetailOverlay()">x</button>
            <h2>Object Detail: <span id="object-detail-key"></span></h2>
            <table class="object-detail-table" style="width:100%;">
                <tbody id="object-detail-body">
                </tbody>
            </table>
        </div>
    </div>

    <div id="bucket-settings-overlay" class="overlay">
        <div class="overlay-content" style="position:relative; width: 600px;">
            <button class="close-btn" onclick="hideBucketSettingsOverlay()">x</button>
            <h2>Bucket Settings: <span id="settings-bucket-name"></span></h2>
            
            <div style="margin-bottom: 20px;">
                <h3>Versioning</h3>
                <div>
                    <label>Status: <span id="versioning-status">Loading...</span></label>
                    <button onclick="toggleVersioning()" id="versioning-btn" style="margin-left: 10px;">Toggle</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>CORS Configuration</h3>
                <div>
                    <label>Status: <span id="cors-status">Loading...</span></label>
                    <button onclick="enableCORS()" style="margin-left: 10px;">Enable CORS</button>
                    <button onclick="deleteCORS()" style="margin-left: 10px;">Delete CORS</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>Access Control (ACL)</h3>
                <div>
                    <label>Current ACL: <span id="acl-status">Loading...</span></label>
                    <br><br>
                    <select id="acl-select">
                        <option value="private">Private</option>
                        <option value="public-read">Public Read</option>
                    </select>
                    <button onclick="setACL()" style="margin-left: 10px;">Set ACL</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hideBucketSettingsOverlay()">Close</button>
            </div>
        </div>
    </div>

    <div id="presigned-url-overlay" class="overlay">
        <div class="overlay-content" style="position:relative; width: 500px;">
            <button class="close-btn" onclick="hidePresignedURLOverlay()">x</button>
            <h2>Share Object: <span id="presigned-object-key"></span></h2>
            
            <div style="margin-bottom: 15px;">
                <label>Expiration (hours):</label>
                <input type="number" id="expiration-hours" value="1" min="1" max="168" style="margin-left: 10px; width: 80px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Method:</label>
                <select id="presigned-method" style="margin-left: 10px;">
                    <option value="GET">Download (GET)</option>
                    <option value="PUT">Upload (PUT)</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <button onclick="generatePresignedURLAction()">Generate URL</button>
            </div>

            <div id="presigned-url-result" style="display: none;">
                <label>Presigned URL:</label>
                <textarea id="presigned-url-text" readonly style="width: 100%; height: 100px; margin-top: 5px;"></textarea>
                <button onclick="copyPresignedURL()" style="margin-top: 10px;">Copy URL</button>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hidePresignedURLOverlay()">Close</button>
            </div>
        </div>
    </div>

    <div id="object-versions-overlay" class="overlay">
        <div class="overlay-content" style="position:relative; width: 800px;">
            <button class="close-btn" onclick="hideObjectVersionsOverlay()">x</button>
            <h2>Object Versions in: <span id="versions-bucket-name"></span></h2>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px;">Object Key</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Version ID</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Size</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Last Modified</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Latest</th>
                    </tr>
                </thead>
                <tbody id="object-versions-body">
                </tbody>
            </table>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hideObjectVersionsOverlay()">Close</button>
            </div>
        </div>
    </div>

<script>
const connConfig = "{{.ConnectionConfig}}";

function showProgressBar() {
    const bar = document.getElementById('progressBar');
    const cont = document.getElementById('progressBarContainer');
    bar.style.width = '0%'; cont.style.display = 'block';
    setTimeout(() => { bar.style.width = '100%'; }, 50);
}
function hideProgressBar() {
    setTimeout(() => {
        document.getElementById('progressBarContainer').style.display = 'none';
        document.getElementById('timeDisplay').textContent = '';
    }, 500);
}

function createBucket() {
    const name = document.getElementById('new-bucket-name').value.trim();
    if (!name) return alert('Bucket name required!');
    showProgressBar();
    
    // Use S3 standard API
    fetch(`/spider/${name}?ConnectionName=${connConfig}`, {
        method: 'PUT'
    })
    .then(response => {
        if (response.ok) {
            hideBucketCreateOverlay(); 
            location.reload();
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function deleteBucket(name) {
    if (!confirm(`Delete bucket "${name}"?`)) return;
    showProgressBar();
    
    // Use S3 standard API
    fetch(`/spider/${name}?ConnectionName=${connConfig}`, { method: 'DELETE' })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function deleteSelectedBuckets() {
    const checked = document.querySelectorAll('input[name="bucket-checkbox"]:checked');
    if (!checked.length) return alert("Select bucket(s) to delete!");
    if (!confirm("Delete selected bucket(s)?")) return;
    showProgressBar();
    
    Promise.all(Array.from(checked).map(chk =>
        fetch(`/spider/${chk.value}?ConnectionName=${connConfig}`, { method: 'DELETE' })
    )).then(() => { 
        location.reload(); 
        hideProgressBar(); 
    }).catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function showBucketCreateOverlay() { document.getElementById('bucket-create-overlay').style.display = 'flex'; }
function hideBucketCreateOverlay() { document.getElementById('bucket-create-overlay').style.display = 'none'; }

let currentBucket = null;
function showObjectPanel(bucket) {
    currentBucket = bucket;
    document.querySelectorAll('.bucket-name-cell').forEach(el => el.classList.remove('selected'));
    document.getElementById(`bucket-${bucket}`).classList.add('selected');
    document.getElementById('object-panel').style.display = 'block';
    fetchObjects(bucket);
}

function hideObjectPanel() {
    document.getElementById('object-panel').style.display = 'none';
    document.getElementById('object-list-body').innerHTML = '';
    document.querySelectorAll('.bucket-name-cell').forEach(el => el.classList.remove('selected'));
    currentBucket = null;
}

function fetchObjects(bucket) {
    // Use S3 standard API
    fetch(`/spider/${bucket}?ConnectionName=${connConfig}`)
        .then(response => response.text())
        .then(xmlData => {
            // Parse XML response
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, 'text/xml');
            const contents = xmlDoc.getElementsByTagName('Contents');
            
            const body = document.getElementById('object-list-body');
            body.innerHTML = '';
            
            for (let i = 0; i < contents.length; i++) {
                const content = contents[i];
                const key = content.getElementsByTagName('Key')[0]?.textContent || '';
                const size = parseInt(content.getElementsByTagName('Size')[0]?.textContent || '0');
                const lastModified = content.getElementsByTagName('LastModified')[0]?.textContent || '';
                
                body.innerHTML += `
                    <tr>
                        <td class="column-num">${i+1}</td>
                        <td class="object-key-cell"><span style="cursor:pointer;" onclick="showObjectDetail('${bucket}','${key}')">${key}</span></td>
                        <td class="center-align">${formatBytes(size)}</td>
                        <td class="center-align">${formatTime(lastModified)}</td>
                        <td class="center-align">
                            <button onclick="downloadObject('${bucket}','${key}')">Download</button>
                            <button onclick="deleteObject('${bucket}','${key}')">Delete</button>
                            <button onclick="generatePresignedURL('${bucket}','${key}')">Share</button>
                        </td>
                        <td class="center-align"><input type="checkbox" name="object-checkbox" value="${key}"></td>
                    </tr>
                `;
            }
        })
        .catch(e => {
            console.error('Error fetching objects:', e);
            alert('Error fetching objects: ' + e.message);
        });
}

function deleteObject(bucket, objectKey) {
    if (!confirm(`Delete object "${objectKey}"?`)) return;
    showProgressBar();
    
    // Use S3 standard API
    fetch(`/spider/${bucket}/${encodeURIComponent(objectKey)}?ConnectionName=${connConfig}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            fetchObjects(bucket); 
            hideProgressBar(); 
            uncheckAllCheckboxes('object');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function deleteSelectedObjects() {
    const checked = document.querySelectorAll('input[name="object-checkbox"]:checked');
    if (!checked.length) return alert("Select object(s) to delete!");
    if (!confirm("Delete selected object(s)?")) return;
    showProgressBar();
    
    // Use S3 standard bulk delete API
    const objectsXml = Array.from(checked).map(chk => 
        `<Object><Key>${chk.value}</Key></Object>`
    ).join('');
    
    const deleteXml = `<?xml version="1.0" encoding="UTF-8"?>
<Delete>
    ${objectsXml}
</Delete>`;
    
    fetch(`/spider/${currentBucket}?delete&ConnectionName=${connConfig}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/xml'
        },
        body: deleteXml
    })
    .then(response => {
        if (response.ok) {
            fetchObjects(currentBucket); 
            hideProgressBar(); 
            uncheckAllCheckboxes('object');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function uncheckAllCheckboxes(mode) {
    const checkboxes = document.getElementsByName(mode + '-checkbox');
    for (const c of checkboxes) {
        c.checked = false;
    }
    
    const selectAllCheckboxes = document.querySelectorAll(`#${mode}-table thead input[type="checkbox"]`);
    selectAllCheckboxes.forEach(cb => cb.checked = false);
    
    if (mode === 'bucket') {
        const fixedHeaderCheckbox = document.querySelector('.fixed-action-buttons input[type="checkbox"]');
        if (fixedHeaderCheckbox) fixedHeaderCheckbox.checked = false;
    }
    
    if (mode === 'object') {
        const objectPanelCheckbox = document.querySelector('.object-panel-actions input[type="checkbox"]');
        if (objectPanelCheckbox) objectPanelCheckbox.checked = false;
    }
}

function showObjectUploadOverlay() {
    if (!currentBucket) return;
    document.getElementById('upload-bucket-name').innerText = currentBucket;
    document.getElementById('object-upload-overlay').style.display = 'flex';
    document.getElementById('file-input').value = '';
    document.getElementById('selected-files-list').innerHTML = 'No files selected';
    document.getElementById('upload-progress').style.display = 'none';
    
    document.getElementById('file-input').addEventListener('change', function(e) {
        const files = e.target.files;
        const fileList = document.getElementById('selected-files-list');
        if (files.length === 0) {
            fileList.innerHTML = 'No files selected';
        } else {
            fileList.innerHTML = '<strong>Selected files:</strong><br>';
            for (let i = 0; i < files.length; i++) {
                fileList.innerHTML += `${i + 1}. ${files[i].name} (${formatBytes(files[i].size)})<br>`;
            }
        }
    });
}

function hideObjectUploadOverlay() { 
    document.getElementById('object-upload-overlay').style.display = 'none';
    document.getElementById('file-input').value = '';
    document.getElementById('selected-files-list').innerHTML = 'No files selected';
    document.getElementById('upload-progress').style.display = 'none';
}

async function uploadFiles() {
    const files = document.getElementById('file-input').files;
    if (!files.length) return alert('Please select files to upload!');
    
    const uploadBtn = document.getElementById('upload-btn');
    uploadBtn.disabled = true;
    document.getElementById('upload-progress').style.display = 'block';
    
    let successCount = 0;
    let failedFiles = [];
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        document.getElementById('current-file').textContent = file.name;
        document.getElementById('progress-bar-inner').style.width = '0%';
        document.getElementById('progress-text').textContent = `0% (${i + 1}/${files.length})`;
        
        try {
            // Use S3 standard API for upload
            const response = await uploadWithProgress(`/spider/${currentBucket}/${encodeURIComponent(file.name)}?ConnectionName=${connConfig}`, file, (progress) => {
                document.getElementById('progress-bar-inner').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `${Math.round(progress)}% (${i + 1}/${files.length})`;
            });
            
            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText} (${response.status})`);
            }
            
            successCount++;
            console.log(`Successfully uploaded: ${file.name}`);
            
        } catch (error) {
            console.error(`Failed to upload ${file.name}:`, error);
            failedFiles.push({name: file.name, error: error.message});
        }
    }
    
    uploadBtn.disabled = false;
    
    if (failedFiles.length > 0) {
        let errorMsg = `Successfully uploaded ${successCount} file(s).\n\nFailed files:\n`;
        failedFiles.forEach(f => {
            errorMsg += `- ${f.name}: ${f.error}\n`;
        });
        alert(errorMsg);
    }
    
    hideObjectUploadOverlay();
    fetchObjects(currentBucket);
}

function uploadWithProgress(url, file, onProgress) {
    return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                onProgress(percentComplete);
            }
        });
        
        xhr.addEventListener('load', () => {
            if (xhr.status >= 200 && xhr.status < 300) {
                resolve({ ok: true, status: xhr.status, statusText: xhr.statusText });
            } else {
                resolve({ ok: false, status: xhr.status, statusText: xhr.statusText });
            }
        });
        
        xhr.addEventListener('error', () => {
            reject(new Error('Network error'));
        });
        
        xhr.addEventListener('timeout', () => reject(new Error('Request timeout')));
        
        xhr.open('PUT', url, true);
        xhr.timeout = 600000; // 10 minutes timeout for large files
        xhr.send(file);
    });
}

function showObjectDetail(bucket, key) {
    showProgressBar();
    
    // Use S3 standard API HEAD request to get object metadata
    fetch(`/spider/${bucket}/${encodeURIComponent(key)}?ConnectionName=${connConfig}`, {
        method: 'HEAD'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const size = response.headers.get('Content-Length') || '0';
        const lastModified = response.headers.get('Last-Modified') || '';
        const etag = response.headers.get('ETag') || '';
        const contentType = response.headers.get('Content-Type') || '';
        
        document.getElementById('object-detail-key').innerText = key;
        const tbody = document.getElementById('object-detail-body');
        tbody.innerHTML = `
            <tr><th>Key</th><td>${key}</td></tr>
            <tr><th>Size</th><td>${formatBytes(parseInt(size))}</td></tr>
            <tr><th>Last Modified</th><td>${lastModified}</td></tr>
            <tr><th>ETag</th><td>${etag}</td></tr>
            <tr><th>ContentType</th><td>${contentType}</td></tr>
            <tr><th>Actions</th><td>
                <button onclick="downloadObject('${bucket}','${key}')">Download</button>
                <button onclick="generatePresignedURL('${bucket}','${key}')">Share</button>
            </td></tr>
        `;
        document.getElementById('object-detail-overlay').style.display = 'flex';
        hideProgressBar();
    })
    .catch(e => { 
        alert('Error: ' + e.message); 
        hideProgressBar(); 
    });
}

function hideObjectDetailOverlay() { 
    document.getElementById('object-detail-overlay').style.display = 'none'; 
}

function downloadObject(bucket, key) {
    // Use S3 standard API for download
    const url = `/spider/${bucket}/${encodeURIComponent(key)}?ConnectionName=${connConfig}`;
    window.open(url, '_blank');
}

// Advanced S3 Features

function showBucketSettings(bucketName) {
    document.getElementById('settings-bucket-name').textContent = bucketName;
    document.getElementById('bucket-settings-overlay').style.display = 'flex';
    
    // Load current settings
    loadBucketSettings(bucketName);
}

function hideBucketSettingsOverlay() {
    document.getElementById('bucket-settings-overlay').style.display = 'none';
}

async function loadBucketSettings(bucketName) {
    try {
        // Load versioning status
        const versioningResponse = await fetch(`/spider/${bucketName}?versioning&ConnectionName=${connConfig}`);
        if (versioningResponse.ok) {
            const versioningXml = await versioningResponse.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(versioningXml, 'text/xml');
            const status = xmlDoc.getElementsByTagName('Status')[0]?.textContent || 'Suspended';
            document.getElementById('versioning-status').textContent = status;
        } else {
            document.getElementById('versioning-status').textContent = 'Suspended';
        }

        // Load CORS status
        const corsResponse = await fetch(`/spider/${bucketName}?cors&ConnectionName=${connConfig}`);
        if (corsResponse.ok) {
            document.getElementById('cors-status').textContent = 'Configured';
        } else {
            document.getElementById('cors-status').textContent = 'Not configured';
        }

        // Load ACL status
        const aclResponse = await fetch(`/spider/${bucketName}?acl&ConnectionName=${connConfig}`);
        if (aclResponse.ok) {
            const aclXml = await aclResponse.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(aclXml, 'text/xml');
            const grants = xmlDoc.getElementsByTagName('Grant');
            let isPublic = false;
            for (let i = 0; i < grants.length; i++) {
                const uri = grants[i].getElementsByTagName('URI')[0]?.textContent;
                const permission = grants[i].getElementsByTagName('Permission')[0]?.textContent;
                if (uri && uri.includes('AllUsers') && permission === 'READ') {
                    isPublic = true;
                    break;
                }
            }
            document.getElementById('acl-status').textContent = isPublic ? 'Public Read' : 'Private';
            document.getElementById('acl-select').value = isPublic ? 'public-read' : 'private';
        } else {
            document.getElementById('acl-status').textContent = 'Private';
            document.getElementById('acl-select').value = 'private';
        }

    } catch (error) {
        console.error('Error loading bucket settings:', error);
    }
}

async function toggleVersioning() {
    const bucketName = document.getElementById('settings-bucket-name').textContent;
    const currentStatus = document.getElementById('versioning-status').textContent;
    const newStatus = currentStatus === 'Enabled' ? 'Suspended' : 'Enabled';
    
    console.log(`Toggling versioning for bucket: ${bucketName}, from ${currentStatus} to ${newStatus}`);
    
    try {
        const versioningXml = `<?xml version="1.0" encoding="UTF-8"?>
<VersioningConfiguration>
    <Status>${newStatus}</Status>
</VersioningConfiguration>`;

        // Use the correct endpoint - make sure it goes to GetS3Bucket which handles versioning
        const url = `/spider/${bucketName}?versioning&ConnectionName=${connConfig}`;
        console.log(`Making PUT request to: ${url}`);
        console.log(`Request body: ${versioningXml}`);

        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/xml',
                'X-Connection-Name': connConfig  // Add header as backup
            },
            body: versioningXml
        });

        console.log(`Response status: ${response.status} ${response.statusText}`);

        if (response.ok) {
            document.getElementById('versioning-status').textContent = newStatus;
            alert(`Versioning ${newStatus.toLowerCase()} successfully`);
        } else {
            const responseText = await response.text();
            console.error(`Error response: ${responseText}`);
            
            // Try to parse S3 error response
            if (responseText.includes('<Error>')) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(responseText, 'text/xml');
                const errorCode = xmlDoc.getElementsByTagName('Code')[0]?.textContent || 'Unknown';
                const errorMessage = xmlDoc.getElementsByTagName('Message')[0]?.textContent || responseText;
                throw new Error(`${errorCode}: ${errorMessage}`);
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error('Toggle versioning error:', error);
        alert('Error toggling versioning: ' + error.message);
    }
}

async function enableCORS() {
    const bucketName = document.getElementById('settings-bucket-name').textContent;
    
    try {
        const corsXml = `<?xml version="1.0" encoding="UTF-8"?>
<CORSConfiguration>
    <CORSRule>
        <AllowedOrigin>*</AllowedOrigin>
        <AllowedMethod>GET</AllowedMethod>
        <AllowedMethod>PUT</AllowedMethod>
        <AllowedMethod>POST</AllowedMethod>
        <AllowedMethod>DELETE</AllowedMethod>
        <AllowedMethod>HEAD</AllowedMethod>
        <AllowedHeader>*</AllowedHeader>
        <ExposeHeader>ETag</ExposeHeader>
        <ExposeHeader>x-amz-server-side-encryption</ExposeHeader>
        <ExposeHeader>x-amz-request-id</ExposeHeader>
        <ExposeHeader>x-amz-id-2</ExposeHeader>
        <MaxAgeSeconds>3600</MaxAgeSeconds>
    </CORSRule>
</CORSConfiguration>`;

        const response = await fetch(`/spider/${bucketName}?cors&ConnectionName=${connConfig}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/xml'
            },
            body: corsXml
        });

        if (response.ok) {
            document.getElementById('cors-status').textContent = 'Configured';
            alert('CORS enabled successfully');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        alert('Error enabling CORS: ' + error.message);
    }
}

async function deleteCORS() {
    const bucketName = document.getElementById('settings-bucket-name').textContent;
    
    try {
        const response = await fetch(`/spider/${bucketName}?cors&ConnectionName=${connConfig}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            document.getElementById('cors-status').textContent = 'Not configured';
            alert('CORS deleted successfully');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        alert('Error deleting CORS: ' + error.message);
    }
}

async function setACL() {
    const bucketName = document.getElementById('settings-bucket-name').textContent;
    const aclValue = document.getElementById('acl-select').value;
    
    try {
        const response = await fetch(`/spider/${bucketName}?acl&ConnectionName=${connConfig}`, {
            method: 'PUT',
            headers: {
                'x-amz-acl': aclValue
            }
        });

        if (response.ok) {
            document.getElementById('acl-status').textContent = aclValue === 'public-read' ? 'Public Read' : 'Private';
            alert('ACL set successfully');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        alert('Error setting ACL: ' + error.message);
    }
}

function generatePresignedURL(bucket, key) {
    document.getElementById('presigned-object-key').textContent = key;
    document.getElementById('presigned-url-result').style.display = 'none';
    document.getElementById('presigned-url-overlay').style.display = 'flex';
    
    // Store current context for the action
    window.currentPresignedContext = { bucket, key };
}

function hidePresignedURLOverlay() {
    document.getElementById('presigned-url-overlay').style.display = 'none';
    document.getElementById('presigned-url-result').style.display = 'none';
}

async function generatePresignedURLAction() {
    const { bucket, key } = window.currentPresignedContext;
    const hours = parseInt(document.getElementById('expiration-hours').value) || 1;
    const method = document.getElementById('presigned-method').value;
    const expiresSeconds = hours * 3600;

    try {
        // Note: This requires the presigned URL endpoint to be implemented
        // For now, we'll show a placeholder URL
        const presignedURL = `/spider/${bucket}/${encodeURIComponent(key)}?ConnectionName=${connConfig}&expires=${Date.now() + (expiresSeconds * 1000)}`;
        
        document.getElementById('presigned-url-text').value = presignedURL;
        document.getElementById('presigned-url-result').style.display = 'block';
        
        // In a real implementation, you would call:
        // const response = await fetch('/spider/s3/object/presigned-url', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({
        //         ConnectionName: connConfig,
        //         BucketName: bucket,
        //         ObjectName: key,
        //         Method: method,
        //         ExpiresSeconds: expiresSeconds
        //     })
        // });
        // const data = await response.json();
        // document.getElementById('presigned-url-text').value = data.PresignedURL;
        
    } catch (error) {
        alert('Error generating presigned URL: ' + error.message);
    }
}

function copyPresignedURL() {
    const urlText = document.getElementById('presigned-url-text');
    urlText.select();
    urlText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(urlText.value).then(() => {
        alert('URL copied to clipboard!');
    }).catch(() => {
        alert('Failed to copy URL to clipboard');
    });
}

function showObjectVersions() {
    if (!currentBucket) return;
    
    document.getElementById('versions-bucket-name').textContent = currentBucket;
    document.getElementById('object-versions-overlay').style.display = 'flex';
    
    loadObjectVersions(currentBucket);
}

function hideObjectVersionsOverlay() {
    document.getElementById('object-versions-overlay').style.display = 'none';
}

async function loadObjectVersions(bucketName) {
    try {
        const response = await fetch(`/spider/${bucketName}?versions&ConnectionName=${connConfig}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const xmlData = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlData, 'text/xml');
        
        const versions = xmlDoc.getElementsByTagName('Version');
        const deleteMarkers = xmlDoc.getElementsByTagName('DeleteMarker');
        
        const tbody = document.getElementById('object-versions-body');
        tbody.innerHTML = '';

        // Process versions
        for (let i = 0; i < versions.length; i++) {
            const version = versions[i];
            const key = version.getElementsByTagName('Key')[0]?.textContent || '';
            const versionId = version.getElementsByTagName('VersionId')[0]?.textContent || '';
            const size = parseInt(version.getElementsByTagName('Size')[0]?.textContent || '0');
            const lastModified = version.getElementsByTagName('LastModified')[0]?.textContent || '';
            const isLatest = version.getElementsByTagName('IsLatest')[0]?.textContent === 'true';

            tbody.innerHTML += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${key}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${versionId}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatBytes(size)}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatTime(lastModified)}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${isLatest ? 'Yes' : 'No'}</td>
                </tr>
            `;
        }

        // Process delete markers
        for (let i = 0; i < deleteMarkers.length; i++) {
            const marker = deleteMarkers[i];
            const key = marker.getElementsByTagName('Key')[0]?.textContent || '';
            const versionId = marker.getElementsByTagName('VersionId')[0]?.textContent || '';
            const lastModified = marker.getElementsByTagName('LastModified')[0]?.textContent || '';
            const isLatest = marker.getElementsByTagName('IsLatest')[0]?.textContent === 'true';

            tbody.innerHTML += `
                <tr style="background-color: #ffe6e6;">
                    <td style="border: 1px solid #ddd; padding: 8px;">${key} (DELETE MARKER)</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${versionId}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">-</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatTime(lastModified)}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${isLatest ? 'Yes' : 'No'}</td>
                </tr>
            `;
        }

        if (versions.length === 0 && deleteMarkers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No versions found</td></tr>';
        }

    } catch (error) {
        console.error('Error loading object versions:', error);
        document.getElementById('object-versions-body').innerHTML = 
            '<tr><td colspan="5" style="text-align: center; padding: 20px;">Error loading versions: ' + error.message + '</td></tr>';
    }
}

function searchKeyword() {
    const filter = document.getElementById('searchInput').value.trim().toUpperCase();
    highlightRows(document.getElementById('bucket-table'), filter);
    highlightRows(document.getElementById('object-table'), filter);
}

function highlightRows(table, filter) {
    if (!table) return;
    const trs = table.getElementsByTagName('tr');
    for (let i=1; i<trs.length; i++) {
        let found = false;
        for (let j=0; j<trs[i].cells.length; j++) {
            if ((trs[i].cells[j].textContent||'').toUpperCase().indexOf(filter) > -1) found = true;
        }
        trs[i].style.background = found && filter ? '#fffab6' : '';
    }
}

function clearSearchInput() {
    document.getElementById('searchInput').value = '';
    searchKeyword();
}

function toggleSelectAll(source, mode) {
    let checkboxes = [];
    if (mode === 'bucket') checkboxes = document.getElementsByName('bucket-checkbox');
    if (mode === 'object') checkboxes = document.getElementsByName('object-checkbox');
    for (const c of checkboxes) c.checked = source.checked;
}

function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function formatBytes(bytes) {
    if (!bytes || isNaN(bytes)) return '';
    if (bytes < 1024) return bytes + ' B';
    let kb = bytes/1024;
    if (kb < 1024) return kb.toFixed(1)+' KB';
    let mb = kb/1024;
    if (mb < 1024) return mb.toFixed(1)+' MB';
    let gb = mb/1024;
    return gb.toFixed(1)+' GB';
}

document.addEventListener('DOMContentLoaded', () => {});
</script>
</body>
</html>