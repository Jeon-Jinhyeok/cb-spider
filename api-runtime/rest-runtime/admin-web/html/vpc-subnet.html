<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VPC/Subnet Management</title>
<style>
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
    }
    .header-container {
        display: flex;
        align-items: flex-end;
    }
    .header-container img {
        margin-right: 10px;
        height: 28px;
    }
    .header-container h1 {
        font-size: 16px;
        margin: 0;
    }
    .header-container .conn-name {
        font-size: 16px;
        margin-left: 10px;
        color: #888;
    }
    h2 {
        font-size: 16px;
        margin: 10px 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 0; /* Remove margin at the bottom of the table */
    }
    th, td {
        border: 1px solid black;
        padding: 6px;
        position: relative;
    }
    th {
        background-color: #f2f2f2;
        font-size: 14px;
        text-align: center;
    }
    td {
        text-align: left;
    }
    .center-align {
        text-align: center;
    }
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .overlay-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: left;
    }
    .fixed-header {
        position: fixed;
        top: 0;
        width: 97%;
        background-color: white;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        padding: 10px 20px;
        align-items: center;
        box-shadow: 0 4px 6px -6px #222;
    }
    .fixed-action-buttons {
        display: flex;
        align-items: center;
        position: relative;
        top: 57px;
    }
    .fixed-action-buttons button {
        margin-left: 10px;
        font-size: 14px;
        font-weight: bold;
    }
    .add-button {
        font-size: 14px;
        font-weight: bold;
        margin-left: 1px;
        margin-bottom: 10px;
    }
    .content {
        margin-top: 70px;
    }
    .checkbox-cell {
        width: 5%;
        text-align: center;
    }
    .highlight-pastel-blue {
        color: #4A90E2;
        font-weight: bold;
    }
    .select-button {
        margin-left: 10px;
        font-size: 10px;
        padding: 3px 5px;
    }
    .disabled-input {
        background-color: #f0f0f0;
        color: #a0a0a0;
        border: 1px solid #d0d0d0;
    }
    .select-list-item {
        color: #0645AD;
        text-decoration: underline;
        cursor: pointer;
    }
    .select-list-item:hover {
        color: #0B0080;
    }
    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .form-group label {
        flex: 1;
        text-align: right;
        margin-right: 10px;
    }
    .form-group input {
        flex: 2;
    }
    .form-group button {
        margin-left: 10px;
    }
    .error-message {
        background-color: #F8D7DA;
        color: #721C24;
        padding: 20px;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        text-align: center;
    }
    .error-message button {
        display: block;
        margin: 20px auto 0;
    }
    .tag-container {
        display: inline-block;
        background-color: #e1e1e1;
        border-radius: 3px;
        padding: 2px 5px;
        margin: 2px;
        white-space: nowrap; /* Ensure tags do not wrap to a new line */
        overflow: hidden; /* Ensure tags do not overflow their container */
        text-overflow: ellipsis; /* Ensure tags are properly truncated */
    }
    .vpc-name {
        width: 10%; /* Reduced width for Name */
    }
    .vpc-cidr {
        width: 10%; /* Reduced width for CIDR */
    }
    .subnet-info {
        width: 35%; /* Slightly increased width for Subnet Info */
    }
    .tags {
        width: 25%; /* Increased width for Cloud Tags */
    }
    .misc {
        width: 15%; /* Adjusted width for Misc */
    }
    .inner-table th {
        background-color: #f9f9f9;
        font-size: 12px;
        text-align: center;
    }
    .inner-table td {
        font-size: 12px;
        text-align: center;
    }
    .inner-table .tags-cell {
        text-align: left; /* Left align for Cloud Tags cell */
        width: 50%; /* Increased width for Cloud Tags cell */
    }
    .inner-table .actions-cell {
        width: 5%; /* Reduced width for actions cell */
    }
    .inner-table .tags-cell div {
        display: inline-block;
        padding: 2px 5px;
        max-width: 100%;
        white-space: nowrap; /* Ensure tags do not wrap to a new line */
        overflow: hidden; /* Ensure tags do not overflow their container */
        text-overflow: ellipsis; /* Ensure tags are properly truncated */
    }
    .inner-table button.delete-btn {
        width: auto; /* Restore original width for delete button */
        font-size: 14px; /* Match VPC button font size */
        font-weight: bold; /* Match VPC button font weight */
    }
    .inner-table button.add-btn {
        width: auto; /* Reduced width for add button */
        font-size: 14px; /* Match VPC button font size */
        font-weight: bold; /* Match VPC button font weight */
    }
</style>
<script>
    let currentProvider = '';

    function showError(message, title) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        const formattedMessage = message.split('.').join('.<br>');
        errorDiv.innerHTML = `<p>${title}</p><p>${formattedMessage}</p><button onclick="closeError()">OK</button>`;
        document.body.appendChild(errorDiv);
        document.addEventListener('keydown', handleEscError);
    }

    function closeError() {
        const errorDiv = document.querySelector('.error-message');
        if (errorDiv) {
            errorDiv.remove();
            document.removeEventListener('keydown', handleEscError);
        }
    }

    function handleEscError(event) {
        if (event.key === "Escape") {
            closeError();
        }
    }

    function deleteVPC(vpcName) {
        const connConfig = document.getElementById('connConfig').value;
        const data = {
            ConnectionName: connConfig
        };

        fetch(`/spider/vpc/${vpcName}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.Result === "true") {
                location.reload();
            } else {
                showError("Failed to delete VPC: " + (data.Message || "Unknown error"), "VPC Name: " + vpcName);
            }
        })
        .catch(error => {
            showError("Error deleting VPC: " + error.message, "VPC Name: " + vpcName);
        });
    }

    function deleteSelectedVPCs() {
        const connConfig = document.getElementById('connConfig').value;
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]:checked');
        if (checkboxes.length === 0) {
            alert("Please select VPCs to delete.");
            return;
        }

        if (!confirm("Are you sure you want to delete the selected VPCs?")) {
            return;
        }

        const deletePromises = Array.from(checkboxes).map(checkbox => {
            const vpcName = checkbox.value;
            const data = {
                ConnectionName: connConfig
            };

            return fetch(`/spider/vpc/${vpcName}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message);
                    });
                }
                return response.json();
            });
        });

        Promise.all(deletePromises)
            .then(dataList => {
                let allSuccess = true;
                dataList.forEach((data, index) => {
                    if (data.Result !== "true") {
                        allSuccess = false;
                        showError("Failed to delete some VPCs: " + (data.Message || "Unknown error"), "VPC Name: " + checkboxes[index].value);
                    }
                });
                if (allSuccess) {
                    location.reload();
                }
            })
            .catch(error => {
                showError("Error deleting VPCs: " + error.message, "Multiple VPCs");
            });
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="deleteCheckbox"]');
        for (const checkbox of checkboxes) {
            checkbox.checked = source.checked;
        }
    }

    function validateForm() {
        const vpcName = document.getElementById('vpcName').value;
        const vpcCIDR = document.getElementById('vpcCIDR').value;
        const subnetInfo = document.getElementById('subnetInfo').value;

        if (!vpcName || !vpcCIDR || !subnetInfo) {
            alert("Please fill in all the fields.");
            return false;
        }
        return true;
    }

    function postVPC() {
        if (!validateForm()) {
            return;
        }

        const connConfig = document.getElementById('connConfig').value;
        const vpcName = document.getElementById('vpcName').value;
        const vpcCIDR = document.getElementById('vpcCIDR').value;
        const subnetInfo = document.getElementById('subnetInfo').value;

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                Name: vpcName,
                IPv4_CIDR: vpcCIDR,
                SubnetInfoList: JSON.parse(subnetInfo)
            }
        };

        fetch('/spider/vpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                location.reload();
            }
        })
        .catch(error => {
            showError("Error creating VPC: " + error.message, "VPC Name: " + vpcName);
        });
    }

    function showOverlay() {
        document.getElementById('overlay').style.display = 'flex';
        document.addEventListener('keydown', handleEsc);
    }

    function hideOverlay() {
        document.getElementById('overlay').style.display = 'none';
        document.removeEventListener('keydown', handleEsc);
        clearFormFields();
    }

    function handleEsc(event) {
        if (event.key === "Escape") {
            hideOverlay();
        }
    }

    function clearFormFields() {
        document.getElementById('vpcName').value = '';
        document.getElementById('vpcCIDR').value = '';
        document.getElementById('subnetInfo').value = '';
    }

    function showSubnetOverlay(vpcName) {
        document.getElementById('subnetVPCName').value = vpcName;
        document.getElementById('subnetVPCNameDisplay').value = vpcName;
        document.getElementById('subnet-overlay').style.display = 'flex';
        document.addEventListener('keydown', handleEscSubnet);
    }

    function hideSubnetOverlay() {
        document.getElementById('subnet-overlay').style.display = 'none';
        document.removeEventListener('keydown', handleEscSubnet);
        clearSubnetFormFields();
    }

    function handleEscSubnet(event) {
        if (event.key === "Escape") {
            hideSubnetOverlay();
        }
    }

    function clearSubnetFormFields() {
        document.getElementById('subnetVPCName').value = '';
        document.getElementById('subnetName').value = '';
        document.getElementById('subnetCIDR').value = '';
        document.getElementById('subnetZone').value = '';
    }

    function addSubnet() {
        const vpcName = document.getElementById('subnetVPCName').value;
        const connConfig = document.getElementById('connConfig').value;
        const subnetName = document.getElementById('subnetName').value;
        const subnetCIDR = document.getElementById('subnetCIDR').value;
        const subnetZone = document.getElementById('subnetZone').value;

        const data = {
            ConnectionName: connConfig,
            ReqInfo: {
                Name: subnetName,
                IPv4_CIDR: subnetCIDR,
                Zone: subnetZone
            }
        };

        fetch(`/spider/vpc/${vpcName}/subnet`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                location.reload();
            }
        })
        .catch(error => {
            showError("Error creating Subnet: " + error.message, "Subnet Name: " + subnetName);
        });
    }

    function deleteSubnet(vpcName, subnetName) {
        const connConfig = document.getElementById('connConfig').value;
        const data = {
                ConnectionName: connConfig
            };
        fetch(`/spider/vpc/${vpcName}/subnet/${subnetName}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.message);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.Result === "true") {
                location.reload();
            } else {
                showError("Failed to delete Subnet: " + (data.Message || "Unknown error"), "Subnet Name: " + subnetName);
            }
        })
        .catch(error => {
            showError("Error deleting Subnet: " + error.message, "Subnet Name: " + subnetName);
        });
    }
</script>
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <img src="/spider/adminweb/images/left-menu/vpc.png" alt="VPC Icon">
            <h1>VPC/Subnet Management <span class="conn-name">({{.ConnectionConfig}})</span></h1>
        </div>
        <div class="fixed-action-buttons">
            <input type="checkbox" onclick="toggleSelectAll(this)">
            <button onclick="deleteSelectedVPCs()">Delete</button>
        </div>
    </div>
    
    <div class="content">
        <button class="add-button" onclick="showOverlay()">+</button>
        <table id="vpc-table">
            <tr>
                <th class="vpc-name center-align">Name</th>
                <th class="vpc-cidr center-align">CIDR</th>
                <th class="subnet-info">Subnet Info</th>
                <th class="tags center-align">Cloud Tags</th>
                <th class="misc center-align">Misc</th>
                <th class="checkbox-cell center-align"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
            </tr>
            {{range .VPCs}}
            {{ $vpcNameId := .IId.NameId }}
            <tr>
                <td class="vpc-name center-align">{{.IId.NameId}}</td>
                <td class="vpc-cidr center-align">{{.IPv4_CIDR}}</td>
                <td class="subnet-info">
                    <table class="inner-table">
                        <tr>
                            <th>Name</th>
                            <th>CIDR</th>
                            <th>Zone</th>
                            <th>Cloud Tags</th>
                            <th><button class="add-btn" onclick="showSubnetOverlay('{{$vpcNameId}}')">+</button></th>
                        </tr>
                        {{range .SubnetInfoList}}
                        <tr>
                            <td>{{.IId.NameId}}</td>
                            <td>{{.IPv4_CIDR}}</td>
                            <td>{{.Zone}}</td>
                            <td class="tags-cell">
                                {{range .TagList}}
                                    <div class="tag-container">{{.Key}}: {{.Value}}</div>
                                {{end}}
                            </td>
                            <td class="actions-cell">
                                <button class="delete-btn" onclick="deleteSubnet('{{$vpcNameId}}', '{{.IId.NameId}}')">-</button>
                            </td>
                        </tr>
                        {{end}}
                    </table>
                </td>
                <td class="tags">
                    {{range .TagList}}
                        <div class="tag-container">{{.Key}}: {{.Value}}</div>
                    {{end}}
                </td>
                <td class="misc">
                    {{range .KeyValueList}}{{.Key}} : {{.Value}}<br>{{end}}
                </td>
                <td class="checkbox-cell center-align">
                    <input type="checkbox" name="deleteCheckbox" value="{{.IId.NameId}}">
                </td>
            </tr>
            {{end}}
        </table>
        {{if not .VPCs}}
        <p>No VPCs found for this connection.</p>
        {{end}}
    </div>

    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <h2>Add New VPC/Subnet</h2>
            <form id="addVPCForm" onsubmit="event.preventDefault(); postVPC();">
                <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
                <div class="form-group">
                    <label for="vpcName">VPC Name:</label>
                    <input type="text" id="vpcName" name="vpcName" required>
                </div>
                <div class="form-group">
                    <label for="vpcCIDR">VPC CIDR:</label>
                    <input type="text" id="vpcCIDR" name="vpcCIDR" required>
                </div>
                <div class="form-group">
                    <label for="subnetInfo">Subnet Info:</label>
                    <textarea id="subnetInfo" name="subnetInfo" rows="5" cols="33" required>[{ "Name": "subnet-01", "Zone": "zone-1", "IPv4_CIDR": "10.0.1.0/24" }]</textarea>
                </div>
                <div class="form-group">
                    <button type="submit">Add VPC</button>
                    <button type="button" onclick="hideOverlay()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="subnet-overlay" class="overlay">
        <div class="overlay-content">
            <h2>Add New Subnet</h2>
            <form id="addSubnetForm" onsubmit="event.preventDefault(); addSubnet();">
                <input type="hidden" id="subnetVPCName">
                <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
                <div class="form-group">
                    <label for="subnetVPCNameDisplay">VPC Name:</label>
                    <input type="text" id="subnetVPCNameDisplay" name="subnetVPCNameDisplay" readonly>
                </div>
                <div class="form-group">
                    <label for="subnetName">Subnet Name:</label>
                    <input type="text" id="subnetName" name="subnetName" required>
                </div>
                <div class="form-group">
                    <label for="subnetCIDR">Subnet CIDR:</label>
                    <input type="text" id="subnetCIDR" name="subnetCIDR" required>
                </div>
                <div class="form-group">
                    <label for="subnetZone">Subnet Zone:</label>
                    <input type="text" id="subnetZone" name="subnetZone" required>
                </div>
                <div class="form-group">
                    <button type="submit">Add Subnet</button>
                    <button type="button" onclick="hideSubnetOverlay()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <input type="hidden" id="connConfig" value="{{.ConnectionConfig}}">
</body>
</html>
